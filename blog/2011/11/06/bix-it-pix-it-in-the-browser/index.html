<!DOCTYPE html><html lang="en" prefix="og: http://ogp.me/ns#"><head><link rel="icon" sizes="any" type="image/svg+xml" href="/images/3d4226764423/favfish.svg"><title>Bix-it: pix-it in the browser | einarwh</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta property="og:title" content="Bix-it: pix-it in the browser"><meta property="og:url" content="https://einarwh.no/blog/2011/11/06/bix-it-pix-it-in-the-browser/"><link rel="stylesheet" href="/bundles/460d8eeb81b7/app.css"></head><body><header><a href="/">einarwh</a><hr></header><h1>Bix-it: pix-it in the browser</h1>
<p class="blog-post-date">November 6, 2011</p>
<p>The <a href="/blog/2011/11/04/pix-it-war/">previous blog post</a> introduced <strong>PixItHandler</strong>, a custom HTTP handler for ASP.NET. The handler responds to HTTP POST requests containing a JSON description of a 8-bit style image with an actual PNG image. Provided you know the expected JSON format, it’s pretty easy to use a tool like <a href="http://www.fiddler2.com/fiddler2/">Fiddler</a> (or <a href="http://curl.haxx.se/">cURL</a> for that matter) to generate renderings of your favorite retro game characters. However, while you might (and should) find those tools on the machine of a web developer, they have somewhat limited penetration among more conventional users. Web browsers have better reach, if you will.</p>
<p>So a challenge remains before the <strong>PixItHandler</strong> is ready to take over the world. Say we wanted to include a pix-it image in a regular HTML page? That is, we would like the user to make the request from a plain ol’ web browser, and use it to display the resulting image to the user. We can’t just use an HTML <strong>img</strong> tag as we normally would, since it issues an HTTP GET request for the resource specified in the <strong>src</strong> attribute. Moreover, we lack a way of including the JSON payload with the request. We can use another approach though. Using JQuery, we can issue the appropriate POST request with the JSON payload to the HTTP handler. So that means we’re halfway there.</p>
<p>We’re not quite done, though. We still need to figure out what to do with the response. The HTTP response from the <strong>PixItHandler</strong> is a binary file - it’s not something you can easily inject into the DOM for rendering. So that’s our next challenge.</p>
<p>Luckily, a little-known HTML feature called the <a href="http://tools.ietf.org/html/rfc2397">data URI scheme</a> comes to the rescue! Basically, data URIs allow you to jam a blob of binary data representing a resource in where you’d normally put the URI for that resource. So in our case, we can use a data URI in the <strong>src</strong> attribute of our <strong>img</strong> tag. To do so, we must base64-encode the PNG image and prefix it with some appropriate incantations identifying the text string as a data URI. Base64-encoding is straightforward to do, and there are <a href="http://www.webtoolkit.info/javascript-base64.html">JavaScript implementations</a> you could steal right off the Internet. Good stuff.</p>
<p>You might think I’d declare victory at this point, but there’s one more obstacle in our way. Unfortunately, it seems that JQuery isn’t entirely happy funnelling the binary response through to us. Loading up binary data isn’t really the scenario the XMLHttpRequest object was designed to support, and so different browsers may or may not allow this to proceed smoothly. I haven’t really gone down to the bottom of the rabbit hole on this issue, because there’s a much simpler solution available: do the base64-encoding server side and pass the image data as text. So I’ve written a <strong>BixItHandler</strong> which is almost identical to the <strong>PixItHandler</strong>, except it base64-encodes the result before writing it to the response stream:</p>
<pre class="codehilite"><code class="language-csharp"><span></span><span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">WriteResponse</span><span class="p">(</span>
  <span class="n">HttpResponse</span> <span class="n">response</span><span class="p">,</span> 
  <span class="kt">byte</span><span class="p">[]</span> <span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">response</span><span class="p">.</span><span class="n">ContentType</span> <span class="p">=</span> <span class="s">"plain/text"</span><span class="p">;</span>
   <span class="n">response</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">Convert</span><span class="p">.</span><span class="n">ToBase64String</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
   <span class="n">response</span><span class="p">.</span><span class="n">Flush</span><span class="p">();</span>
<span class="p">}</span>
</code></pre>
<p>Problem solved! Now we can easily create an HTML page with some JQuery to showcase our pix-it images. Here’s one way to do it:</p>
<pre class="codehilite"><code class="language-html"><span></span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Invaders!<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">style</span> <span class="na">type</span><span class="o">=</span><span class="s">"text/css"</span><span class="p">&gt;</span>
      <span class="p">.</span><span class="nc">invader</span> <span class="p">{</span> <span class="k">visibility</span><span class="p">:</span> <span class="kc">hidden</span> <span class="p">}</span>
    <span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"invader"</span><span class="p">&gt;</span>#990000<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"invader"</span><span class="p">&gt;</span>#009900<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"invader"</span><span class="p">&gt;</span>#000099<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">"text/javascript"</span> 
          <span class="na">src</span><span class="o">=</span><span class="s">"scripts/json2.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">"text/javascript"</span> 
          <span class="na">src</span><span class="o">=</span><span class="s">"scripts/jquery-1.6.4.min.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">"text/javascript"</span> 
          <span class="na">src</span><span class="o">=</span><span class="s">"scripts/pixit.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">"text/javascript"</span><span class="p">&gt;</span>
    <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="nx">PixIt</span><span class="p">.</span><span class="nx">load</span><span class="p">);</span>
  <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre>
<p>Not much going on in the HTML file, as you can see. Three innocuous-looking <strong>div</strong>‘s that aren’t even visible yet, that’s all. As you might imagine, they are just placeholders that our JavaScript code can work with. That’s where <em>pixit.js</em> comes in:</p>
<pre class="codehilite"><code class="language-javascript"><span></span><span class="kd">var</span> <span class="nx">PixIt</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">load</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s2">"pixelsWide"</span><span class="o">:</span> <span class="mi">13</span><span class="p">,</span>
      <span class="s2">"pixelsHigh"</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
      <span class="s2">"pixelSize"</span><span class="o">:</span> <span class="mi">8</span><span class="p">,</span>
      <span class="s2">"payload"</span><span class="o">:</span>
       <span class="p">[</span>
         <span class="p">{</span>
           <span class="s2">"color"</span><span class="o">:</span> <span class="s1">'#000000'</span><span class="p">,</span>
           <span class="s2">"pixels"</span><span class="o">:</span>
           <span class="p">[</span>
              <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
              <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
              <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
              <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>
              <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
              <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
              <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
              <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
              <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
              <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
              <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
              <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
           <span class="p">]</span>
         <span class="p">}</span>
       <span class="p">]</span>
    <span class="p">};</span>

    <span class="nx">$</span><span class="p">(</span><span class="s1">'div.invader'</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">inv</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
      <span class="nx">j</span><span class="p">.</span><span class="nx">payload</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">color</span> <span class="o">=</span> <span class="nx">inv</span><span class="p">.</span><span class="nx">text</span><span class="p">();</span>
      <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s1">'POST'</span><span class="p">,</span>
        <span class="nx">url</span><span class="o">:</span> <span class="s2">"http://localhost:52984/bix.it"</span><span class="p">,</span>
        <span class="nx">contentType</span><span class="o">:</span> <span class="s2">"application/json; charset=utf-8"</span><span class="p">,</span>
        <span class="nx">accepts</span><span class="o">:</span> <span class="s2">"plain/text"</span><span class="p">,</span>
        <span class="nx">dataType</span><span class="o">:</span> <span class="s2">"text"</span><span class="p">,</span>
        <span class="nx">data</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">j</span><span class="p">),</span>
        <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">src</span> <span class="o">=</span> <span class="s2">"data:image/png;base64,"</span> <span class="o">+</span> <span class="nx">d</span><span class="p">;</span>
          <span class="nx">inv</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s1">'&lt;img src="'</span> <span class="o">+</span> <span class="nx">src</span> <span class="o">+</span> <span class="s1">'"/&gt;'</span><span class="p">);</span>
          <span class="nx">inv</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s1">'visibility'</span><span class="p">,</span> <span class="s1">'visible'</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>As you can see, we define the basic outline for a space invader as static JSON data in the script. For each of the <strong>div</strong> tags, we hijack the color code inside and use that to override the color for the space invader. Then we issue the POST request to our brand new <strong>BixItHandler</strong>, which has been configured to capture requests aimed at the <strong>bix.it</strong> virtual resource. The response is a base64-encoded PNG file, which we then insert into the <strong>src</strong> attribute of an <strong>img</strong> element that we conjure up on the fly.</p>
<p>And how does it look?</p>
<p><img src="/images/971e29651da3/invaders-in-the-browser.png" alt="Space invaders in the browser"></p>
</body></html>